import{r as e}from"../vendor/vendor-react-core.D1hcyiwY.js";import{s as t}from"../components/components-admin.CiIAoamg.js";function r(){const[r,o]=e.useState(null),[a,s]=e.useState(!1),[n,l]=e.useState(!0),i=async()=>{let e=!0;try{l(!0);const{data:{user:n}}=await t.auth.getUser();if(!n||!e)return void(e&&(o(null),s(!1),l(!1)));const{data:i,error:u}=await t.rpc("is_admin");if(!e)return;if(u)s(!1);else if(s(!!i),i){o("admin");try{localStorage.setItem("userRole","admin"),localStorage.setItem("isAdmin","true"),localStorage.setItem("userRoleTimestamp",Date.now().toString())}catch(r){}return void(e&&l(!1))}try{const{data:a,error:s}=await t.from("user_roles").select("role").eq("user_id",n.id).maybeSingle();if(!e)return;if(s)o("nosubs");else{const e=a?.role||"nosubs";o(e);try{localStorage.setItem("userRole",e),localStorage.setItem("isAdmin","false"),localStorage.setItem("userRoleTimestamp",Date.now().toString())}catch(r){}}}catch(a){e&&o("nosubs")}}catch(a){e&&o("nosubs")}finally{e&&l(!1)}return()=>{e=!1}};return e.useEffect((()=>{!async function(){try{l(!0);const{data:{user:e}}=await t.auth.getUser();if(!e)return o(null),void s(!1);const r=localStorage.getItem("userRole"),a=localStorage.getItem("userRoleTimestamp"),n="true"===localStorage.getItem("isAdmin"),u=Date.now(),c=6e5;if(r&&a&&u-parseInt(a)<c)return o(r),s(n),void l(!1);await i()}catch(e){o("nosubs"),l(!1)}}();const{data:{subscription:e}}=t.auth.onAuthStateChange((e=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e||"USER_UPDATED"===e?i():"SIGNED_OUT"===e&&(localStorage.removeItem("userRole"),localStorage.removeItem("isAdmin"),localStorage.removeItem("userRoleTimestamp"),o(null),s(!1))}));return()=>{e.unsubscribe()}}),[]),{userRole:r,isAdmin:a,loading:n,refreshRole:i}}export{r as u};
//# sourceMappingURL=hooks-useuserrole.ts.BKHSjdY6.js.map
