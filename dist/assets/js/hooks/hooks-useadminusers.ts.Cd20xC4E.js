import{r}from"../vendor/vendor-react-core.D1hcyiwY.js";import{s as e}from"../components/components-admin.CiIAoamg.js";import{u as t}from"./hooks-use-toast.ts.Dg8obzHg.js";import{g as a,u as o}from"../utils/utils-cache.ts.BtmNadnX.js";import{u as s}from"../vendor/vendor--react-i18next.DhHVfoav.js";function i(){const[i,n]=r.useState([]),[u,d]=r.useState(""),[c,l]=r.useState(!1),[_,p]=r.useState(1),{toast:m}=t(),{t:f}=s("common"),h=async()=>{try{return l(!0),await a(o,"admin-users",(async()=>{const{data:r,error:t}=await e.rpc("is_admin");if(t)throw t;if(!r)throw new Error("Unauthorized: User is not an admin");const{data:a,error:o}=await e.functions.invoke("admin-get-users",{body:{}});if(o)throw o;const s=a.users||[];if(0===s.length)return[];const{data:i,error:n}=await e.from("profiles").select("\n              id,\n              username,\n              full_name\n            "),u={};i&&i.forEach((r=>{u[r.id]={username:r.username,full_name:r.full_name}}));const{data:d,error:c}=await e.rpc("get_all_user_roles");if(c)throw c;const{data:l,error:_}=await e.from("blogs").select("author_id"),p={};l&&l.forEach((r=>{p[r.author_id]=(p[r.author_id]||0)+1}));const{data:m,error:f}=await e.from("trips").select("user_id, trip_type").eq("trip_type","ZapTrip"),{data:h,error:z}=await e.from("zapout_data").select("user_id"),{data:w,error:g}=await e.from("zaproad_data").select("user_id"),v={};m&&m.forEach((r=>{v[r.user_id]||(v[r.user_id]={zap_trip:0,zap_out:0,zap_road:0}),v[r.user_id].zap_trip++})),h&&h.forEach((r=>{v[r.user_id]||(v[r.user_id]={zap_trip:0,zap_out:0,zap_road:0}),v[r.user_id].zap_out++})),w&&w.forEach((r=>{v[r.user_id]||(v[r.user_id]={zap_trip:0,zap_out:0,zap_road:0}),v[r.user_id].zap_road++}));return s.map((r=>{const e=r.id,t=u[e]||{},a=d?.find((r=>r.user_id===e)),o=p[e]||0,s=v[e]||{zap_trip:0,zap_out:0,zap_road:0};let i="nosubs";return!a||"admin"!==a.role&&"nosubs"!==a.role&&"tier1"!==a.role&&"tier2"!==a.role&&"tier3"!==a.role&&"tier4"!==a.role&&"enterprise"!==a.role||(i=a.role),{id:e,email:r.email||e,full_name:t.full_name||null,username:t.username||r.email?.split("@")[0]||"user",role:i,post_count:o,zap_trip_count:s.zap_trip,zap_out_count:s.zap_out,zap_road_count:s.zap_road,created_at:r.created_at}}))}),{ttl:3e5})}catch(r){throw r}finally{l(!1)}};r.useEffect((()=>{h().then(n).catch((r=>{m({title:f("toasts.error"),description:f("toasts.fetchError"),variant:"destructive"})}))}),[]);const z=i.filter((r=>r.email.toLowerCase().includes(u.toLowerCase())||r.full_name&&r.full_name.toLowerCase().includes(u.toLowerCase())||r.username.toLowerCase().includes(u.toLowerCase()))),w=Math.ceil(z.length/20),g=z.slice(20*(_-1),20*_);return r.useEffect((()=>{p(1)}),[u]),{users:g,allUsers:i,filteredCount:z.length,loading:c,searchTerm:u,setSearchTerm:d,refreshUsers:async()=>{try{const r=await a(o,"admin-users",(()=>h()),{force:!0});n(r)}catch(r){m({title:f("toasts.error"),description:f("toasts.fetchError"),variant:"destructive"})}},pagination:{currentPage:_,totalPages:w,setCurrentPage:p,hasNextPage:_<w,hasPreviousPage:_>1,startIndex:20*(_-1)+1,endIndex:Math.min(20*_,z.length)}}}export{i as u};
//# sourceMappingURL=hooks-useadminusers.ts.Cd20xC4E.js.map
