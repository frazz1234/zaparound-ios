import{r as e}from"../vendor/vendor-react-core.D1hcyiwY.js";import{s}from"../components/components-admin.CiIAoamg.js";import{u as r}from"./hooks-use-toast.ts.Dg8obzHg.js";import{u as t}from"../vendor/vendor--react-i18next.DhHVfoav.js";function o(){const[o,i]=e.useState(!1),{toast:a}=r(),{t:n}=t("common");return{initiateCheckout:async(e,r)=>{try{i(!0);const{data:{user:t}}=await s.auth.getUser();if(!t)return a({title:n("common.error"),description:n("common.signInRequired"),variant:"destructive"}),{success:!1,url:"/auth"};const{data:o,error:c}=await s.functions.invoke("stripe-payment",{body:{plan:e,userId:t.id,email:t.email,isYearly:r}});return c?(a({title:n("common.error"),description:c.message||n("common.paymentError"),variant:"destructive"}),{success:!1}):{success:!0,url:o.url,sessionId:o.sessionId}}catch(t){return a({title:n("common.error"),description:t.message||n("common.paymentError"),variant:"destructive"}),{success:!1}}finally{i(!1)}},checkPaymentStatus:async e=>{try{const{data:{user:r}}=await s.auth.getUser();if(!r)return{success:!1,error:"User not authenticated"};const{data:t,error:o}=await s.functions.invoke("check-payment-status",{body:{sessionId:e,userId:r.id}});if(o)return{success:!1,error:o.message};if("paid"!==t.status){const{error:e}=await s.from("user_roles").update({role:"nosubs",updated_at:(new Date).toISOString()}).eq("user_id",r.id)}if(r){const{data:e,error:o}=await s.from("user_roles").select("role").eq("user_id",r.id).single();o||t.role&&t.role!==e.role&&(t.role=e.role)}if(t.subscriptionDetails){const{status:e}=t.subscriptionDetails;if(["canceled","unpaid","incomplete_expired"].includes(e)){const{data:e}=await s.from("user_roles").select("role").eq("user_id",r.id).single();if(e&&"nosubs"!==e.role){const{error:e}=await s.from("user_roles").update({role:"nosubs",updated_at:(new Date).toISOString()}).eq("user_id",r.id);e||(t.role="nosubs")}}}return{success:!0,status:t.status,role:t.role,subscription:t.subscription,subscriptionDetails:t.subscriptionDetails}}catch(r){return{success:!1,error:r.message}}},isLoading:o}}export{o as u};
//# sourceMappingURL=hooks-usestripepayment.ts.CZ5-QRGe.js.map
