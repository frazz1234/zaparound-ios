import{s as e}from"../components/components-admin.CiIAoamg.js";const t=.3,a=.25,n=.25,c=.2;class s{userLocation=null;constructor(e){this.userLocation=e||null}calculateDistance(e,t,a,n){const c=(a-e)*Math.PI/180,s=(n-t)*Math.PI/180,r=Math.sin(c/2)*Math.sin(c/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}calculateRecencyScore(e){const t=new Date,a=new Date(e),n=(t.getTime()-a.getTime())/36e5;return Math.exp(-n/24)}calculateProximityScore(e){return this.userLocation&&void 0!==e?e<=50?1:e<=100?.9:e<=200?.8:e<=500?.6:e<=1e3?.4:.3:.5}isAroundTheWorld(e){return e>1e3}calculatePopularityScore(e,t){const a=e+t;return Math.min(1,Math.log10(a+1)/3)}calculateEngagementScore(e,t){const a=(e+t)/10;return Math.min(1,a)}calculateFinalScore(e){const s=this.calculateRecencyScore(e.created_at),r=this.calculateProximityScore(e.distance||0),o=this.calculatePopularityScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0),i=this.calculateEngagementScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0);return s*t+r*a+o*n+i*c}async getFeedPosts(t=1,a=15){try{let n=e.from("community_posts").select("\n          *,\n          likes:post_likes(count),\n          replies:post_replies(count),\n          profile:profiles!user_id (\n            username,\n            first_name,\n            last_name,\n            avatar_url\n          )\n        ").eq("is_published",!0).order("created_at",{ascending:!1});const{data:c,error:s}=await n;if(s)throw s;const r=c.map((e=>{let t;this.userLocation&&e.place_lat&&e.place_lng&&(t=this.calculateDistance(this.userLocation.lat,this.userLocation.lng,e.place_lat,e.place_lng));const a={...e,distance:t,recency_score:this.calculateRecencyScore(e.created_at),popularity_score:this.calculatePopularityScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0),engagement_score:this.calculateEngagementScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0)};return a.final_score=this.calculateFinalScore(a),a}));r.sort(((e,t)=>(t.final_score||0)-(e.final_score||0)));const o=(t-1)*a,i=o+a;return r.slice(o,i)}catch(n){return[]}}async getPopularPosts(t=10){try{const{data:a,error:n}=await e.from("community_posts").select("\n          *,\n          likes:post_likes(count),\n          replies:post_replies(count),\n          profile:profiles!user_id (\n            username,\n            first_name,\n            last_name,\n            avatar_url\n          )\n        ").eq("is_published",!0).order("created_at",{ascending:!1}).limit(2*t);if(n)throw n;const c=a.map((e=>({...e,popularity_score:this.calculatePopularityScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0)})));return c.sort(((e,t)=>(t.popularity_score||0)-(e.popularity_score||0))),c.slice(0,t)}catch(a){return[]}}async getRecentPosts(t=10){try{const a=new Date;a.setDate(a.getDate()-1);const{data:n,error:c}=await e.from("community_posts").select("\n          *,\n          likes:post_likes(count),\n          replies:post_replies(count),\n          profile:profiles!user_id (\n            username,\n            first_name,\n            last_name,\n            avatar_url\n          )\n        ").eq("is_published",!0).gte("created_at",a.toISOString()).order("created_at",{ascending:!1}).limit(t);if(c)throw c;return n}catch(a){return[]}}async getDestinationPosts(t=1,a=15){try{const{data:n,error:c}=await e.from("community_posts").select("\n          *,\n          likes:post_likes(count),\n          replies:post_replies(count),\n          profile:profiles!user_id (\n            username,\n            first_name,\n            last_name,\n            avatar_url\n          )\n        ").eq("is_published",!0).eq("post_type","destination").order("created_at",{ascending:!1}).limit(3*a);if(c)throw c;const s=n.map((e=>{let t;this.userLocation&&e.place_lat&&e.place_lng&&(t=this.calculateDistance(this.userLocation.lat,this.userLocation.lng,e.place_lat,e.place_lng));const a=this.calculatePopularityScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0),n=this.calculateRecencyScore(e.created_at),c=.4*a+.35*n+.25*this.calculateProximityScore(t||0);return{...e,distance:t,popularity_score:a,recency_score:n,engagement_score:this.calculateEngagementScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0),final_score:c}}));s.sort(((e,t)=>(t.final_score||0)-(e.final_score||0)));const r=(t-1)*a,o=r+a;return s.slice(r,o)}catch(n){return[]}}async getAroundTheWorldPosts(t=1,a=15){try{const{data:n,error:c}=await e.from("community_posts").select("\n          *,\n          likes:post_likes(count),\n          replies:post_replies(count),\n          profile:profiles!user_id (\n            username,\n            first_name,\n            last_name,\n            avatar_url\n          )\n        ").eq("is_published",!0).order("created_at",{ascending:!1}).limit(2*a);if(c)throw c;const s=n.map((e=>{let t;return this.userLocation&&e.place_lat&&e.place_lng&&(t=this.calculateDistance(this.userLocation.lat,this.userLocation.lng,e.place_lat,e.place_lng)),{...e,distance:t,popularity_score:this.calculatePopularityScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0),recency_score:this.calculateRecencyScore(e.created_at),engagement_score:this.calculateEngagementScore(e.likes?.[0]?.count||0,e.replies?.[0]?.count||0)}})).filter((e=>e.distance&&e.distance>1e3)).map((e=>({...e,final_score:this.calculateFinalScore(e)})));s.sort(((e,t)=>(t.final_score||0)-(e.final_score||0)));const r=(t-1)*a,o=r+a;return s.slice(r,o)}catch(n){return[]}}updateUserLocation(e){this.userLocation=e}}export{s as F};
//# sourceMappingURL=utils-feedalgorithm.ts.MbBzcL8m.js.map
