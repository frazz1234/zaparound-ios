import{l as e}from"../vendor/vendor--localforage.Ck2fc8VT.js";const t=new class{CACHE_PREFIX="flight_search_";MAX_CACHE_AGE=18e5;OFFER_EXPIRY_BUFFER=3e5;SUPPLIER_TIMEOUT_MULTIPLIER=3;store;constructor(){this.store=e.createInstance({name:"ZapAroundFlightData",storeName:"flight_searches",description:"Flight search data and user progress for ZapAround"}),this.store.setDriver([e.INDEXEDDB,e.WEBSQL,e.LOCALSTORAGE])}generateSearchId(e){const{origin:t,destination:a,departureDate:r,returnDate:s,passengers:i,cabinClass:n,currency:c,maxConnections:h}=e;return btoa(`${t}-${a}-${r}-${s||"oneway"}-${i}-${n}-${c}-${h||1}`).replace(/[^a-zA-Z0-9]/g,"").substring(0,12)}createSearchUrl(e,t="en"){const a=this.generateSearchId(e),r=new URLSearchParams({origin:e.origin,destination:e.destination,departureDate:e.departureDate,passengers:e.passengers.toString(),cabinClass:e.cabinClass,currency:e.currency,searchId:a});return e.returnDate&&r.append("returnDate",e.returnDate),e.maxConnections&&r.append("maxConnections",e.maxConnections.toString()),`/${t}/booking/flights?${r.toString()}`}createFlightDetailsUrl(e,t,a="en"){return`/${a}/booking/flight-details?offerId=${e}&searchId=${this.generateSearchId(t)}`}extractSearchParamsFromUrl(e){try{const t=new URL(e,window.location.origin).searchParams,a=t.get("origin"),r=t.get("destination"),s=t.get("departureDate"),i=t.get("returnDate")||void 0,n=parseInt(t.get("passengers")||"1"),c=t.get("cabinClass")||"economy",h=t.get("currency")||"USD",o=t.get("maxConnections")?parseInt(t.get("maxConnections")):1;return a&&r&&s?{origin:a,destination:r,departureDate:s,returnDate:i,passengers:n,cabinClass:c,currency:h,maxConnections:o}:null}catch(t){return null}}getSearchIdFromUrl(e){try{return new URL(e,window.location.origin).searchParams.get("searchId")}catch(t){return null}}isOffersExpired(e){if(!e.expires_at)return!1;return(new Date).getTime()>=new Date(e.expires_at).getTime()-this.OFFER_EXPIRY_BUFFER}isSearchDataStale(e){const t=Date.now()-e.searchTimestamp,a=e.timing.supplier_timeout||2e4;return t>Math.max(a*this.SUPPLIER_TIMEOUT_MULTIPLIER,this.MAX_CACHE_AGE)}async saveFlightData(e,t,a,r,s){const i=this.generateSearchId(e),n={searchParams:e,searchResults:t,timing:a,searchTimestamp:Date.now(),selectedOfferId:r,userProgress:s||{currentStep:"search"},searchId:i};try{return await this.cleanupCache(),await this.store.setItem(`${this.CACHE_PREFIX}${i}`,n),i}catch(c){try{return await this.aggressiveCleanup(),await this.store.setItem(`${this.CACHE_PREFIX}${i}`,n),i}catch(h){return i}}}async loadFlightDataBySearchId(e){try{const t=await this.store.getItem(`${this.CACHE_PREFIX}${e}`);if(!t)return null;const a=t;return this.isOffersExpired(a.timing)?(await this.removeFlightDataBySearchId(e),null):(this.isSearchDataStale(a)&&(a.needsRefresh=!0),a)}catch(t){return null}}async loadFlightData(e){const t=this.generateSearchId(e);return await this.loadFlightDataBySearchId(t)}async updateUserProgress(e,t){const a=this.generateSearchId(e),r=await this.loadFlightDataBySearchId(a);r&&(r.userProgress={...r.userProgress,...t},await this.saveFlightData(r.searchParams,r.searchResults,r.timing,r.selectedOfferId,r.userProgress))}async updateSelectedOffer(e,t){const a=this.generateSearchId(e),r=await this.loadFlightDataBySearchId(a);r&&(r.selectedOfferId=t,await this.saveFlightData(r.searchParams,r.searchResults,r.timing,t,r.userProgress))}async removeFlightDataBySearchId(e){try{await this.store.removeItem(`${this.CACHE_PREFIX}${e}`)}catch(t){}}async removeFlightData(e){const t=this.generateSearchId(e);await this.removeFlightDataBySearchId(t)}async getAllCachedSearches(){const e={};try{const t=await this.store.keys();for(const a of t)if(a.startsWith(this.CACHE_PREFIX)){const t=await this.store.getItem(a);if(t){const r=t;e[a.replace(this.CACHE_PREFIX,"")]=r}}}catch(t){}return e}async cleanupCache(){const e=await this.getAllCachedSearches();for(const[t,a]of Object.entries(e)){const e=this.isOffersExpired(a.timing),r=this.isSearchDataStale(a);(e||r)&&await this.removeFlightDataBySearchId(t)}}async aggressiveCleanup(){const e=await this.getAllCachedSearches(),t=Object.entries(e).sort((([,e],[,t])=>e.searchTimestamp-t.searchTimestamp)),a=(t.slice(-5),t.slice(0,-5));for(const[r]of a)await this.removeFlightDataBySearchId(r)}async logStorageStats(){try{const t=await this.getAllCachedSearches();Object.keys(t).length;let a=0;for(const[e,r]of Object.entries(t)){a+=JSON.stringify(r).length}try{await this.store.setItem("test_quota_check","test"),await this.store.removeItem("test_quota_check")}catch(e){}}catch(e){}}async needsRefresh(e){const t=await this.loadFlightData(e);return t?this.isOffersExpired(t.timing)?{needsRefresh:!0,reason:"expired"}:this.isSearchDataStale(t)?{needsRefresh:!0,reason:"stale"}:{needsRefresh:!1,reason:null}:{needsRefresh:!0,reason:null}}async getTimeRemaining(e){const t=await this.loadFlightData(e);if(!t||!t.timing.expires_at)return 0;const a=(new Date).getTime(),r=new Date(t.timing.expires_at).getTime();return Math.max(0,r-a)}formatTimeRemaining(e){if(e<=0)return"00:00";const t=Math.floor(e/1e3),a=t%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}};export{t as f};
//# sourceMappingURL=utils-flightdatapersistence.ts.C7K1q72P.js.map
