import{r as e,j as s}from"../vendor/vendor-react-core.D1hcyiwY.js";import{s as t}from"../components/components-admin.CiIAoamg.js";import{u as a}from"../hooks/hooks-use-toast.ts.Dg8obzHg.js";import{B as r,D as i,f as l,g as n,j as o}from"../components/components-ui.C8hnNhgu.js";import{b as c,M as d}from"../components/components-community.DdS-HWu3.js";import{c as m}from"../components/components-blog.C3TFiFB1.js";import{L as u,u as p,U as h,bq as f,T as x}from"../vendor/vendor--lucide-react.DRw9PYsu.js";import{a as g,u as j}from"../vendor/vendor--react-router.Gdfmkz0l.js";const v=()=>{const{postId:v}=g(),y=j(),{toast:w}=a(),[_,b]=e.useState(null),[N,S]=e.useState([]),[U,E]=e.useState(!0),[$,P]=e.useState(1),[k,C]=e.useState(!0),[F,L]=e.useState(!1),[D,T]=e.useState(null),[q,M]=e.useState({}),[R,A]=e.useState(""),[B,z]=e.useState([]),[Y,I]=e.useState(!1);e.useEffect((()=>{G(),W()}),[v]);const W=async()=>{const{data:{user:e}}=await t.auth.getUser();T(e)},G=async()=>{try{E(!0);const{data:e,error:s}=await t.from("community_posts").select("\n          *,\n          likes:post_likes(count),\n          profile:profiles!user_id (\n            username,\n            first_name,\n            last_name,\n            avatar_url\n          )\n        ").eq("id",v).single();if(s)throw s;b(e),await H()}catch(e){w({title:"Error",description:"Failed to fetch post. Please try again.",variant:"destructive"})}finally{E(!1)}},H=async(e=1)=>{try{1===e?E(!0):L(!0);const{data:s,error:a,count:r}=await t.from("post_replies").select("\n          *,\n          profile:profiles!post_replies_user_id_fkey (\n            username,\n            first_name,\n            last_name,\n            avatar_url\n          )\n        ",{count:"exact"}).eq("post_id",v).order("created_at",{ascending:!1}).range(20*(e-1),20*e-1);if(a)throw a;C(r>20*e),S(1===e?s:e=>[...e,...s])}catch(s){w({title:"Error",description:"Failed to fetch replies. Please try again.",variant:"destructive"})}finally{E(!1),L(!1)}};return U?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsx(u,{className:"h-8 w-8 animate-spin text-blue-500"})}):_?s.jsx("div",{className:"min-h-screen bg-gray-50",children:s.jsxs("div",{className:"container max-w-3xl mx-auto px-4 py-8",children:[s.jsxs(r,{variant:"ghost",onClick:()=>y("/community"),className:"mb-4 flex items-center gap-2",children:[s.jsx(p,{className:"h-4 w-4"}),"Back to Community"]}),s.jsxs("div",{className:"bg-white rounded-2xl shadow-sm p-6 mb-6",children:[s.jsx("div",{className:"flex items-center justify-between mb-4",children:s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"h-12 w-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center shadow-sm overflow-hidden",children:_.profile?.avatar_url?s.jsx("img",{src:t.storage.from("avatars").getPublicUrl(_.profile.avatar_url).data.publicUrl,alt:_.profile.username||`${_.profile.first_name||""} ${_.profile.last_name||""}`.trim()||"User",className:"w-full h-full object-cover",onError:e=>{e.currentTarget.style.display="none",e.currentTarget.parentElement.classList.remove("overflow-hidden")}}):s.jsx(h,{className:"h-6 w-6 text-blue-500"})}),s.jsxs("div",{className:"ml-4",children:[s.jsx("p",{className:"font-semibold text-gray-800",children:_.profile?.username||`${_.profile?.first_name||""} ${_.profile?.last_name||""}`.trim()||"Anonymous User"}),s.jsx("p",{className:"text-sm text-gray-500",children:new Date(_.created_at).toLocaleString()})]})]})}),s.jsxs("div",{className:"bg-gray-50 rounded-xl p-4 mb-4",children:[s.jsx("p",{className:"text-gray-700 leading-relaxed",children:_.content}),_.media_urls&&_.media_urls.length>0||_.image_url?s.jsx("div",{className:"mt-4",children:s.jsx(c,{media:_.media_urls&&_.media_urls.length>0?_.media_urls:_.image_url,maxPreview:10})}):null]})]}),s.jsx("div",{className:"bg-white rounded-xl shadow-sm p-6 mb-6",children:s.jsxs("div",{className:"space-y-4",children:[s.jsx("textarea",{value:R,onChange:e=>A(e.target.value),placeholder:"Write a reply...",className:"w-full p-2 border rounded-md",rows:3}),s.jsx(d,{onMediaChange:e=>{z(e)},maxFiles:5,disabled:Y}),s.jsx(r,{size:"sm",onClick:async()=>{if(R.trim())try{I(!0);const{data:{user:e}}=await t.auth.getUser();if(!e)return void w({title:"Error",description:"You must be logged in to reply.",variant:"destructive"});let s=[];B.length>0&&(s=await(async e=>{if(!e||0===e.length)return[];try{const{data:{user:s}}=await t.auth.getUser();if(!s)throw new Error("No authenticated user found");const a=[];for(const r of e){const e=r.file.name.split(".").pop(),i=`${s.id}_${Date.now()}_${Math.random().toString(36).substr(2,9)}.${e}`,{data:l,error:n}=await t.storage.from("community-images").upload(i,r.file,{cacheControl:"3600",upsert:!1});if(n)throw n;const{data:{publicUrl:o}}=t.storage.from("community-images").getPublicUrl(i);a.push({id:r.id,url:o,type:r.type,thumbnail:"video"===r.type?r.preview:null})}return a}catch(a){return w({title:"Error",description:"Failed to upload media. Please try again.",variant:"destructive"}),[]}})(B));const{error:a}=await t.from("post_replies").insert([{post_id:v,user_id:e.id,content:R,media_urls:s}]);if(a)throw a;A(""),z([]),await H(),w({title:"Success",description:"Your reply has been posted."})}catch(e){w({title:"Error",description:"Failed to post reply. Please try again.",variant:"destructive"})}finally{I(!1)}else w({title:"Error",description:"Reply content cannot be empty.",variant:"destructive"})},disabled:Y,className:m("relative px-4 py-1 bg-gradient-to-r from-[#10B981] to-[#059669] text-white border-none hover:from-[#059669] hover:to-[#047857] hover:scale-105 transition-all duration-300 shadow-lg rounded-full font-medium tracking-wide flex items-center gap-2"),children:Y?s.jsxs(s.Fragment,{children:[s.jsx(u,{className:"h-4 w-4 animate-spin"}),"Posting..."]}):"Reply"})]})}),s.jsxs("div",{className:"space-y-4",children:[N.map((e=>s.jsxs("div",{className:"bg-white rounded-lg p-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"h-8 w-8 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center shadow-sm overflow-hidden",children:e.profile?.avatar_url?s.jsx("img",{src:t.storage.from("avatars").getPublicUrl(e.profile.avatar_url).data.publicUrl,alt:e.profile.username||`${e.profile.first_name||""} ${e.profile.last_name||""}`.trim()||"User",className:"w-full h-full object-cover",onError:e=>{e.currentTarget.style.display="none",e.currentTarget.parentElement.classList.remove("overflow-hidden")}}):s.jsx(h,{className:"h-4 w-4 text-blue-500"})}),s.jsxs("div",{className:"ml-2",children:[s.jsx("p",{className:"font-semibold text-sm",children:e.profile?.username||`${e.profile?.first_name||""} ${e.profile?.last_name||""}`.trim()||"Anonymous User"}),s.jsx("p",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleString()})]})]}),D?.id===e.user_id&&s.jsxs(i,{children:[s.jsx(l,{asChild:!0,children:s.jsx(r,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:s.jsx(f,{className:"h-4 w-4"})})}),s.jsx(n,{align:"end",children:s.jsxs(o,{className:"text-red-600",onClick:()=>(async e=>{try{const{error:s}=await t.from("post_replies").delete().eq("id",e);if(s)throw s;await H(),w({title:"Success",description:"Reply deleted successfully."})}catch(s){w({title:"Error",description:"Failed to delete reply. Please try again.",variant:"destructive"})}})(e.id),children:[s.jsx(x,{className:"h-4 w-4 mr-2"}),"Delete"]})})]})]}),s.jsx("p",{className:"text-gray-700 text-sm",children:e.content}),e.media_urls&&e.media_urls.length>0||e.image_url?s.jsx("div",{className:"mt-2",children:s.jsx(c,{media:e.media_urls&&e.media_urls.length>0?e.media_urls:e.image_url,maxPreview:3})}):null]},`reply-${e.id}`))),k&&s.jsx("div",{className:"flex justify-center mt-6",children:s.jsx(r,{variant:"outline",onClick:async()=>{const e=$+1;P(e),await H(e)},disabled:F,className:"flex items-center gap-2",children:F?s.jsxs(s.Fragment,{children:[s.jsx(u,{className:"h-4 w-4 animate-spin"}),"Loading..."]}):"Load More Replies"})})]})]})}):s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsx("p",{className:"text-gray-500",children:"Post not found"})})};export{v as C};
//# sourceMappingURL=page-communitypost.BfV0LMtV.js.map
